{% extends "base.html" %}

{% block content %}
<div class="flex-center" style="justify-content: space-between; margin-bottom: 2rem;">
  <h1>Analysis Dashboard</h1>
  <div class="gap-2" style="display: flex;">
    <button onclick="takeSnapshot()" class="btn btn-primary">
      <i class="fa-solid fa-camera"></i> Take Snapshot
    </button>
    <a href="{{ url_for('adjacency_matrix') }}" target="_blank" class="btn btn-secondary">
      <i class="fa-solid fa-table"></i> Export Matrix
    </a>
  </div>
</div>

<!-- Stats Grid -->
<div class="dashboard-grid">
  <div class="card stat-card">
    <div class="stat-value">{{ stats.total_pages }}</div>
    <div class="stat-label">Total Pages</div>
  </div>
  <div class="card stat-card">
    <div class="stat-value">{{ stats.total_links }}</div>
    <div class="stat-label">Total Links</div>
  </div>
  <div class="card stat-card">
    <div class="stat-value">{{ "%.2f"|format(avg_conn) }}</div>
    <div class="stat-label">Avg Connections</div>
  </div>
  <div class="card stat-card">
    <div class="stat-value">{{ stats.connected_components }}</div>
    <div class="stat-label">Connected Components</div>
  </div>
</div>

<div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
  <!-- Hubs -->
  <div class="card">
    <h3><i class="fa-solid fa-network-wired" style="color: var(--accent-color)"></i> Top Hubs</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Page</th>
            <th>In-Links</th>
          </tr>
        </thead>
        <tbody>
          {% for page, count in hubs %}
          <tr>
            <td>{{ page }}</td>
            <td>{{ count }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="2" style="color: var(--text-secondary)">No hubs found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Orphans -->
  <div class="card">
    <h3><i class="fa-solid fa-ghost" style="color: var(--warning)"></i> Orphan Pages</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Page</th>
          </tr>
        </thead>
        <tbody>
          {% for page in orphans %}
          <tr>
            <td>{{ page }}</td>
          </tr>
          {% else %}
          <tr>
            <td style="color: var(--text-secondary)">No orphans found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-4">
  <h3><i class="fa-solid fa-link-slash" style="color: var(--danger)"></i> Broken Links</h3>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Source Page</th>
          <th>Missing Target</th>
        </tr>
      </thead>
      <tbody>
        {% for source, target in broken %}
        <tr>
          <td>{{ source }}</td>
          <td>{{ target }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="2" style="color: var(--text-secondary)">No broken links found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Snapshots Section -->
<div class="card mt-4">
  <h3><i class="fa-solid fa-clock-rotate-left"></i> Snapshots History</h3>
  <div id="snapshots-list" class="table-container">
    <!-- Populated by JS -->
    <p style="color: var(--text-secondary); padding: 1rem;">Loading snapshots...</p>
  </div>
</div>

<script>
  async function takeSnapshot() {
    try {
      const response = await fetch("{{ url_for('snapshots') }}", { method: "POST" });
      const data = await response.json();
      alert("Snapshot saved: " + data.filename);
      loadSnapshots();
    } catch (error) {
      console.error("Error taking snapshot:", error);
      alert("Failed to take snapshot.");
    }
  }

  async function loadSnapshots() {
    try {
      const response = await fetch("{{ url_for('snapshots') }}");
      const data = await response.json();

      const container = document.getElementById('snapshots-list');
      if (data.length === 0) {
        container.innerHTML = '<p style="padding: 1rem; color: var(--text-secondary)">No snapshots yet.</p>';
        return;
      }

      let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Pages</th>
                            <th>Links</th>
                            <th>Components</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

      data.forEach(snap => {
        html += `
                    <tr>
                        <td>${snap.date}</td>
                        <td>${snap.total_pages}</td>
                        <td>${snap.total_links}</td>
                        <td>${snap.connected_components}</td>
                    </tr>
                `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;

    } catch (error) {
      console.error("Error loading snapshots:", error);
    }
  }

  // Load snapshots on page load
  document.addEventListener('DOMContentLoaded', loadSnapshots);
</script>
{% endblock %}